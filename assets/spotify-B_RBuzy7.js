var p=Object.defineProperty;var u=(c,e,t)=>e in c?p(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var d=(c,e,t)=>u(c,typeof e!="symbol"?e+"":e,t);class f{constructor(){d(this,"clientId");d(this,"clientSecret");d(this,"redirectUri");this.clientId="",this.clientSecret="",this.redirectUri=""}getRedirectUri(){return this.redirectUri?this.redirectUri:typeof window<"u"?`${window.location.origin}/spotify-callback`:"http://127.0.0.1:5173/spotify-callback"}async getAuthUrl(){const e=["user-library-read","playlist-read-private","playlist-read-collaborative","user-read-email","user-read-private"],t=this.generateCodeVerifier(),r=await this.generateCodeChallenge(t);return localStorage.setItem("spotify_code_verifier",t),`https://accounts.spotify.com/authorize?${new URLSearchParams({response_type:"code",client_id:this.clientId,scope:e.join(" "),redirect_uri:this.getRedirectUri(),state:this.generateRandomString(16),code_challenge:r,code_challenge_method:"S256"}).toString()}`}async getAccessToken(e,t){const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:this.getRedirectUri(),client_id:this.clientId,code_verifier:t})});if(!r.ok){const a=await r.text();throw new Error(`Token exchange failed: ${r.statusText} - ${a}`)}return r.json()}async getCurrentUser(e){const t=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error(`Failed to fetch user: ${t.statusText}`);return t.json()}async getUserPlaylists(e,t=50){let r=[],a=0,s=!0;for(;s;){const i=await fetch(`https://api.spotify.com/v1/me/playlists?limit=${t}&offset=${a}`,{headers:{Authorization:`Bearer ${e}`}});if(!i.ok)throw new Error(`Failed to fetch playlists: ${i.statusText}`);const o=await i.json();r=[...r,...o.items],s=o.items.length===t,a+=t}return r}async getPlaylist(e,t){const r=await fetch(`https://api.spotify.com/v1/playlists/${t}`,{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw new Error(`Failed to fetch playlist: ${r.statusText}`);return r.json()}async getPlaylistTracks(e,t){let r=[],a=0,s=!0;const i=100;for(;s;){const o=await fetch(`https://api.spotify.com/v1/playlists/${t}/tracks?limit=${i}&offset=${a}`,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok)throw new Error(`Failed to fetch playlist tracks: ${o.statusText}`);const h=await o.json(),n=h.items.filter(l=>l.track&&l.track.type==="track").map(l=>l.track);r=[...r,...n],s=h.items.length===i,a+=i}return r}async getAudioFeatures(e,t){const r={};for(let s=0;s<t.length;s+=100){const i=t.slice(s,s+100),o=await fetch(`https://api.spotify.com/v1/audio-features?ids=${i.join(",")}`,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok){const n=await o.text();throw console.error("Spotify Audio Features API error:",{status:o.status,statusText:o.statusText,url:o.url,trackIds:i,errorBody:n}),new Error(`Failed to fetch audio features: ${o.status} ${o.statusText} - ${n}`)}(await o.json()).audio_features.forEach(n=>{n&&n.id&&(r[n.id]={tempo:n.tempo})})}return r}storeTokens(e){localStorage.setItem("spotify_tokens",JSON.stringify({...e,expires_at:Date.now()+e.expires_in*1e3}))}getStoredTokens(){const e=localStorage.getItem("spotify_tokens");if(!e)return null;const t=JSON.parse(e);return Date.now()>=t.expires_at?(localStorage.removeItem("spotify_tokens"),null):t}isAuthenticated(){return this.getStoredTokens()!==null}logout(){localStorage.removeItem("spotify_tokens"),localStorage.removeItem("spotify_user")}generateCodeVerifier(){const e=new Uint8Array(32);return crypto.getRandomValues(e),btoa(String.fromCharCode(...e)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}async generateCodeChallenge(e){const r=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",r);return btoa(String.fromCharCode(...new Uint8Array(a))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}generateRandomString(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let r="";for(let a=0;a<e;a++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}}const y=new f;export{y as s};
